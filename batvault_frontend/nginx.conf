log_format json_combined escape=json
  '{'
    '"ts":"$time_iso8601",'
    '"remote_addr":"$remote_addr",'
    '"request_id":"$request_id",'
    '"trace_id":"$http_x_trace_id",'
    '"upstream_trace_id":"$upstream_http_x_trace_id",'
    '"request_time":$request_time,'
    '"upstream_response_time":"$upstream_response_time",'
    '"status":$status,'
    '"body_bytes_sent":$body_bytes_sent,'
    '"http":{"method":"$request_method","target":"$request_uri","protocol":"$server_protocol"},'
    '"referer":"$http_referer",'
    '"user_agent":"$http_user_agent"'
  '}';

server {

  listen 80;
  root /usr/share/nginx/html;
  index index.html;
  access_log  /var/log/nginx/access.json  json_combined;
  add_header X-Trace-Id $upstream_http_x_trace_id always;
 
  # resolve in-cluster DNS
  resolver 127.0.0.11 ipv6=off valid=30s;

  # ——————————————————————————————
  # 0) Health endpoints (silent, no access log)
  # ——————————————————————————————
  location = /healthz {
    access_log off;
    add_header Cache-Control "no-store";
    return 204;
  }
  location = /readyz {
    access_log off;
    add_header Cache-Control "no-store";
    return 204;
  }

  # ——————————————————————————————
  # 1) Static assets first; if missing → 404
  # ——————————————————————————————
  location ~* \.(?:js|css|png|jpe?g|svg|ico|woff2?)$ {
    root   /usr/share/nginx/html;
    try_files $uri =404;
    expires 30d;
    add_header Cache-Control public;
  }

  # ——————————————————————————————
  # 2) BatVault API Edge (/v3/*) proxy
  #
  # Forward all API calls beginning with /v3/ to the api_edge service. This
  # includes SSE endpoints (/v3/query) and JSON endpoints like
  # /v3/schema/fields. We use HTTP/1.1 for streaming and preserve headers.
  # ——————————————————————————————
  location /v3/ {
    proxy_pass         http://api_edge:8080$request_uri;
    proxy_http_version 1.1;
    proxy_set_header   Host               $http_host;
    proxy_set_header   X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header   X-Request-ID       $request_id;
    proxy_set_header   X-Trace-Id         $http_x_trace_id;
    proxy_set_header   Cache-Control      no-cache;
    proxy_set_header   Connection         "";
  }

  # Back-compat shims: keep old FE/configs working but steer to /v3/*
  location = /query         { return 307 /v3/query; }     # keep method on redirect
  location  /bundles/       { return 307 /v3$uri; }       # /bundles/<rid> → /v3/bundles/<rid>

  # ——————————————————————————————
  # 3) Memory API proxy (/memory/* → memory_api:8000)
  #
  # Trailing slash on proxy_pass rewrites `/memory/...` → `/...` upstream,
  # so FastAPI sees `/api/enrich/batch` exactly as defined in the contract.
  # ——————————————————————————————
  location /memory/ {
    proxy_pass         http://memory_api:8000/;
    proxy_http_version 1.1;
    proxy_set_header   Host               $http_host;
    proxy_set_header   X-Forwarded-Host   $http_host;
    proxy_set_header   X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header   X-Request-ID       $request_id;
    proxy_set_header   X-Trace-Id         $http_x_trace_id;
    proxy_set_header   Cache-Control      no-cache;
    proxy_set_header   Connection         "";
  }

  # ——————————————————————————————
  # 4) API proxy: public runtime config for the frontend bootstrap
  #    MUST be declared before the SPA fallback. Route via Edge so it can
  #    rewrite bases and normalize endpoints for the FE.
  location = /config {
    proxy_pass         http://api_edge:8080/config;
    proxy_http_version 1.1;
    proxy_set_header   Host                $http_host;        # keep ":5173"
    proxy_set_header   X-Forwarded-Host    $http_host;        # keep ":5173"
    proxy_set_header   X-Real-IP           $remote_addr;
    proxy_set_header   X-Forwarded-For     $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto   $scheme;
    proxy_set_header   Accept              "application/json";
  }
  # UI log beacons (v2/v3) and signing key fetch via Edge
  location /v2/ui/logs {
    proxy_pass         http://api_edge:8080$request_uri;
    proxy_http_version 1.1;
    proxy_set_header   Host               $http_host;
    proxy_set_header   X-Request-ID       $request_id;
    proxy_set_header   X-Trace-Id         $http_x_trace_id;
  }
  location /keys/ {
    proxy_pass         http://api_edge:8080$request_uri;
    proxy_http_version 1.1;
    proxy_set_header   Host               $http_host;
    proxy_set_header   X-Request-ID       $request_id;
    proxy_set_header   X-Trace-Id         $http_x_trace_id;
  }
  # 5) SPA fallback (React Router)
  location / {
    try_files $uri $uri/ /index.html;
  }
}
